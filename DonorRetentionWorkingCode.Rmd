---
title: "DonorRetentionWorkingCode"
author: "Owen Salciccioli, Kristin Prunty, Rachel Holman"
date: "10/5/2022"
output: html_document
---

### Load in Libraries
```{r}
library(tidyverse)
library(caret)
library(randomForest)
```

### Read in Data
```{r}
Rel_Type <- read.csv("1_4_Relationship_Type.csv")
Part_Hist <- read.csv("1_5a_Participation_History.csv")
DH1 <- read.csv("DonorHistoryFirstThree")
DH2 <- read.csv("DonorHistorySecondThree")
DH3 <- read.csv("DonorHistoryThirdThree")
DH4 <- read.csv("DonorHistoryFourthThree")
DH5 <- read.csv("DonorHistoryFifthThree")
DH6 <- read.csv("DonorHistorySixthThree")
DH7 <- read.csv("DonorHistoryLastTwo")
```

### Fix relationship spreadsheet
```{r}
Rel_Type_Split <- Rel_Type %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = Relationship.Type, values_from = value)

Rel_Type_Split[is.na(Rel_Type_Split)] <- 0 
## https://stackoverflow.com/questions/8161836/how-do-i-replace-na-values-with-zeros-in-an-r-dataframe%5C
```

## Fix participationship spreadsheet
```{r}
Part_Hist_Split <- Part_Hist %>%
  select(!c(4:7)) %>%
  mutate(Participation.Category = case_when(Participation.Category == "" ~ "Uncategorized",
                                            TRUE ~ Participation.Category)) %>%
  pivot_wider(names_from = Participation.Category, values_from = Activity.Name, values_fn = list)
```

### Clean and add data to Donor History
```{r}
DonorHistory <- cbind(DH1, DH2, DH3, DH4, DH5, DH6, DH7)

remove("DH1", "DH2", "DH3", "DH4", "DH5", "DH6", "DH7")

DonorHistory_Clean <- DonorHistory %>%
  select(!3) %>%
  left_join(Rel_Type_Split) %>%
  left_join(Part_Hist_Split)
```

### Create active donor and retention variables
```{r}
a <- rle(sort(DonorHistory_Clean$Entity.ID))
counts <- data.frame(ID=a$values, count=a$lengths)

retainedAtAll <- counts %>%
  mutate(retainedAtAll = ifelse(count > 1, 1, 0)) %>%
  select(!count)

## https://stackoverflow.com/questions/1923273/counting-the-number-of-elements-with-the-values-of-x-in-a-vector

DonorHistoryRetention <- DonorHistory_Clean %>%
  mutate(Active = ifelse(Fiscal.Year %in% c(2022, 2023), 1, 0)) %>%
  left_join(retainedAtAll, by = c("Entity.ID" = "ID"))
```


